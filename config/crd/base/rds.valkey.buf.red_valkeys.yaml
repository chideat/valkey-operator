---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.15.0
  name: valkeys.rds.valkey.buf.red
spec:
  group: rds.valkey.buf.red
  names:
    kind: Valkey
    listKind: ValkeyList
    plural: valkeys
    singular: valkey
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - description: Instance arch
      jsonPath: .spec.arch
      name: Arch
      type: string
    - description: Valkey version
      jsonPath: .spec.version
      name: Version
      type: string
    - description: Instance access type
      jsonPath: .spec.access.type
      name: Access
      type: string
    - description: Instance phase
      jsonPath: .status.phase
      name: Status
      type: string
    - description: Instance status message
      jsonPath: .status.message
      name: Message
      type: string
    - description: Bundle Version
      jsonPath: .status.upgradeStatus.crVersion
      name: Bundle Version
      type: string
    - description: Enable instance auto upgrade
      jsonPath: .spec.upgradeOption.autoUpgrade
      name: AutoUpgrade
      type: boolean
    - description: Time since creation
      jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: Valkey is the Schema for the valkeys API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: ValkeySpec defines the desired state of Valkey
            properties:
              affinityPolicy:
                description: AffinityPolicy specifies the affinity policy for the
                  Pod
                enum:
                - SoftAntiAffinity
                - AntiAffinityInSharding
                - AntiAffinity
                - CustomAffinity
                type: string
              arch:
                description: Arch supports cluster, sentinel
                enum:
                - cluster
                - sentinel
                - standalone
                type: string
              customAffinity:
                $ref: '#/definitions/k8s.io~1api~1core~1v1~0Affinity'
                description: |-
                  CustomAffinity specifies the custom affinity settings for the Pod
                  if AffinityPolicy is set to CustomAffinity, this field is required
              customConfigs:
                additionalProperties:
                  type: string
                description: |-
                  CustomConfigs defines the configuration settings for Valkey
                  for detailed settings, please refer to https://github.com/valkey-io/valkey/blob/unstable/valkey.conf
                type: object
              exporter:
                description: Exporter defines Valkey exporter settings
                properties:
                  enabled:
                    description: Enabled enable the exporter
                    type: boolean
                  image:
                    description: Image the exporter image
                    type: string
                  imagePullPolicy:
                    $ref: '#/definitions/k8s.io~1api~1core~1v1~0PullPolicy'
                    description: ImagePullPolicy
                  resources:
                    $ref: '#/definitions/k8s.io~1api~1core~1v1~0ResourceRequirements'
                    description: Resources for setting resource requirements for the
                      Pod Resources *v1.ResourceRequirements
                type: object
              instanceAccess:
                description: ' ExternalAccess defines information for Valkey nodePorts
                  settings'
                properties:
                  annotations:
                    additionalProperties:
                      type: string
                    description: The annnotations of the service which will be attached
                      to services
                    type: object
                  certIssuer:
                    description: Cert Issuer for external access TLS certificate
                    type: string
                  certIssuerType:
                    default: ClusterIssuer
                    description: Cert Issuer Type for external access TLS certificate
                    enum:
                    - ClusterIssuer
                    - Issuer
                    type: string
                  defaultPasswordSecret:
                    description: |-
                      DefaultPasswordSecret referered to the secret which defined the password for default user
                      The referered secret must have `password` key whose value matching regex: ^[a-zA-Z0-9_!@#$%^&*()-_=+?]{8,128}$
                    type: string
                  enableTLS:
                    description: EnableTLS enable TLS for external access
                    type: boolean
                  ipFamilyPrefer:
                    $ref: '#/definitions/k8s.io~1api~1core~1v1~0IPFamily'
                    description: |-
                      IPFamily represents the IP Family (IPv4 or IPv6).
                      This type is used to express the family of an IP expressed by a type (e.g. service.spec.ipFamilies).
                    enum:
                    - IPv4
                    - IPv6
                  ports:
                    description: Ports defines the nodeports of NodePort service
                    pattern: ^([0-9]+:[0-9]+)(,[0-9]+:[0-9]+)*$
                    type: string
                  type:
                    $ref: '#/definitions/k8s.io~1api~1core~1v1~0ServiceType'
                    default: ClusterIP
                    description: ServiceType defines the type of the all related services
                    enum:
                    - NodePort
                    - LoadBalancer
                    - ClusterIP
                type: object
              modules:
                description: Modules defines the module settings for Valkey
                items:
                  description: ValkeyModule defines the module for Valkey
                  properties:
                    args:
                      description: |-
                        Args args for module


                        Supported for valkey 8.0+
                      items:
                        type: string
                      type: array
                    name:
                      description: |-
                        Name name of valkey module.


                        .so suffix will be appended if name not suffixed provided
                        if name is a full path, the full path will be used else the module will be loaded from /usr/local/valkey/modules
                      type: string
                  required:
                  - name
                  type: object
                type: array
              nodeSelector:
                additionalProperties:
                  type: string
                description: NodeSelector specifies the node selector for the Pod
                type: object
              podAnnotations:
                additionalProperties:
                  type: string
                description: PodAnnotations holds Kubernetes Pod annotations PodAnnotations
                type: object
              replicas:
                description: Replicas defines desired number of replicas for Valkey
                properties:
                  replicasOfShard:
                    description: ReplicasOfShard defines the number of replicas for
                      each shard
                    format: int32
                    type: integer
                  shards:
                    description: |-
                      Shards defines the number of shards for Valkey
                      for cluster arch, the default value is 3; for other arch, the value is always 1
                    format: int32
                    type: integer
                type: object
              resources:
                $ref: '#/definitions/k8s.io~1api~1core~1v1~0ResourceRequirements'
                description: Resources for setting resource requirements for the Pod
                  Resources *v1.ResourceRequirements
              securityContext:
                $ref: '#/definitions/k8s.io~1api~1core~1v1~0PodSecurityContext'
                description: SecurityContext sets security attributes for the Pod
                  SecurityContex
              sentinel:
                description: Sentinel defines Sentinel configuration settings Sentinel
                properties:
                  access:
                    description: Access the access for sentinel
                    properties:
                      annotations:
                        additionalProperties:
                          type: string
                        description: The annnotations of the service which will be
                          attached to services
                        type: object
                      certIssuer:
                        description: Cert Issuer for external access TLS certificate
                        type: string
                      certIssuerType:
                        default: ClusterIssuer
                        description: Cert Issuer Type for external access TLS certificate
                        enum:
                        - ClusterIssuer
                        - Issuer
                        type: string
                      defaultPasswordSecret:
                        description: |-
                          DefaultPasswordSecret referered to the secret which defined the password for default user
                          The referered secret must have `password` key whose value matching regex: ^[a-zA-Z0-9_!@#$%^&*()-_=+?]{8,128}$
                        type: string
                      enableTLS:
                        description: EnableTLS enable TLS for external access
                        type: boolean
                      externalTLSSecret:
                        description: ExternalTLSSecret the external TLS secret to
                          use, if not provided, the operator will issue one
                        type: string
                      ipFamilyPrefer:
                        $ref: '#/definitions/k8s.io~1api~1core~1v1~0IPFamily'
                        description: |-
                          IPFamily represents the IP Family (IPv4 or IPv6).
                          This type is used to express the family of an IP expressed by a type (e.g. service.spec.ipFamilies).
                        enum:
                        - IPv4
                        - IPv6
                      ports:
                        description: Ports defines the nodeports of NodePort service
                        pattern: ^([0-9]+:[0-9]+)(,[0-9]+:[0-9]+)*$
                        type: string
                      type:
                        $ref: '#/definitions/k8s.io~1api~1core~1v1~0ServiceType'
                        default: ClusterIP
                        description: ServiceType defines the type of the all related
                          services
                        enum:
                        - NodePort
                        - LoadBalancer
                        - ClusterIP
                    type: object
                  affinity:
                    $ref: '#/definitions/k8s.io~1api~1core~1v1~0Affinity'
                    description: Affinity
                  customConfigs:
                    additionalProperties:
                      type: string
                    description: CustomConfigs the config for sentinel
                    type: object
                  exporter:
                    description: Exporter defines the specification for the sentinel
                      exporter
                    properties:
                      enabled:
                        description: Enabled enable the exporter
                        type: boolean
                      image:
                        description: Image the exporter image
                        type: string
                      imagePullPolicy:
                        $ref: '#/definitions/k8s.io~1api~1core~1v1~0PullPolicy'
                        description: ImagePullPolicy
                      resources:
                        $ref: '#/definitions/k8s.io~1api~1core~1v1~0ResourceRequirements'
                        description: Resources for setting resource requirements for
                          the Pod Resources *v1.ResourceRequirements
                    type: object
                  image:
                    description: Image the valkey sentinel image
                    type: string
                  imagePullPolicy:
                    $ref: '#/definitions/k8s.io~1api~1core~1v1~0PullPolicy'
                    description: ImagePullPolicy the image pull policy
                  imagePullSecrets:
                    description: ImagePullSecrets the image pull secrets
                    items:
                      $ref: '#/definitions/k8s.io~1api~1core~1v1~0LocalObjectReference'
                    type: array
                  monitorConfig:
                    additionalProperties:
                      type: string
                    description: |-
                      MonitorConfig configs for sentinel to monitor this replication, including:
                      - down-after-milliseconds
                      - failover-timeout
                      - parallel-syncs
                    type: object
                  nodeSelector:
                    additionalProperties:
                      type: string
                    description: NodeSelector
                    type: object
                  podAnnotations:
                    additionalProperties:
                      type: string
                    description: PodAnnotations
                    type: object
                  quorum:
                    description: |-
                      Quorum the number of Sentinels that need to agree about the fact the master is not reachable,
                      in order to really mark the master as failing, and eventually start a failover procedure if possible.
                      If not specified, the default value is the majority of the Sentinels.
                    format: int32
                    type: integer
                  replicas:
                    description: Replicas the number of sentinel replicas
                    format: int32
                    minimum: 3
                    type: integer
                  resources:
                    $ref: '#/definitions/k8s.io~1api~1core~1v1~0ResourceRequirements'
                    description: Resources the resources for sentinel
                  securityContext:
                    $ref: '#/definitions/k8s.io~1api~1core~1v1~0PodSecurityContext'
                    description: SecurityContext
                  sentinelReference:
                    description: SentinelReference the sentinel reference
                    properties:
                      auth:
                        description: Auth the sentinel auth
                        properties:
                          passwordSecret:
                            description: PasswordSecret the password secret for valkey
                            type: string
                          tlsSecret:
                            description: TLSSecret the tls secret
                            type: string
                          username:
                            description: Username the username for valkey
                            type: string
                        type: object
                      nodes:
                        description: Addresses the sentinel addresses
                        items:
                          properties:
                            flags:
                              description: Flags
                              type: string
                            ip:
                              description: IP the sentinel node ip
                              type: string
                            port:
                              description: Port the sentinel node port
                              format: int32
                              type: integer
                          type: object
                        minItems: 3
                        type: array
                    type: object
                  tolerations:
                    description: Tolerations
                    items:
                      $ref: '#/definitions/k8s.io~1api~1core~1v1~0Toleration'
                    type: array
                type: object
              storage:
                description: Storage defines the storage settings for Valkey
                properties:
                  accessMode:
                    $ref: '#/definitions/k8s.io~1api~1core~1v1~0PersistentVolumeAccessMode'
                    default: ReadWriteOnce
                    description: AccessMode is the access mode of the volume.
                  capacity:
                    anyOf:
                    - type: integer
                    - type: string
                    description: |-
                      Capacity is the cap of the volume to request.
                      if not set and StorageClassName is set, the default StorageClass size will be the double size of memory limit.
                    pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                    x-kubernetes-int-or-string: true
                  retainAfterDeleted:
                    description: RetainAfterDeleted defines whether the storage should
                      be retained after the ValkeyCluster is deleted
                    type: boolean
                  storageClassName:
                    description: |-
                      storageClassName is the name of the StorageClass required by the claim.
                      if not set, the default StorageClass will be used
                    type: string
                type: object
              tolerations:
                description: tolerations defines tolerations for the Pod
                items:
                  $ref: '#/definitions/k8s.io~1api~1core~1v1~0Toleration'
                type: array
              version:
                description: Version supports 7.2, 8.0
                enum:
                - "7.2"
                - "8.0"
                type: string
            required:
            - arch
            - replicas
            - resources
            - version
            type: object
          status:
            description: ValkeyStatus defines the observed state of Valkey
            properties:
              clusterNodes:
                description: ClusterNodes valkey nodes info
                items:
                  description: ValkeyNode represent a ValkeyCluster Node
                  properties:
                    id:
                      description: ID is the valkey cluster node id, not runid
                      type: string
                    ip:
                      description: IP is the ip of the node. if access announce is
                        enabled, it will be the access ip
                      type: string
                    masterRef:
                      description: MasterRef is the master node id of this node
                      type: string
                    nodeName:
                      description: NodeName is the node name of the node where holds
                        the pod
                      type: string
                    podName:
                      description: PodName current pod name
                      type: string
                    port:
                      description: Port is the port of the node. if access announce
                        is enabled, it will be the access port
                      type: string
                    role:
                      description: Role is the role of the node, master or slave
                      type: string
                    shardId:
                      description: ShardID cluster shard id of the node
                      type: string
                    slots:
                      description: 'Slots is the slot range for the shard, eg: 0-1000,1002,1005-1100'
                      type: string
                    statefulSet:
                      description: StatefulSet is the statefulset name of this pod
                      type: string
                  required:
                  - ip
                  - nodeName
                  - podName
                  - port
                  - role
                  - statefulSet
                  type: object
                type: array
              lastShardCount:
                description: LastShardCount indicates the last number of shards in
                  the Valkey Cluster.
                format: int32
                type: integer
              lastVersion:
                description: LastVersion indicates the last version of the Valkey
                  instance.
                type: string
              matchLabels:
                additionalProperties:
                  type: string
                description: Matching labels selector for Valkey
                type: object
              message:
                description: This field contains an additional message for the instance's
                  status
                type: string
              passwordSecretName:
                description: The name of the kubernetes Secret that contains Valkey
                  password.
                type: string
              phase:
                description: |-
                  Phase indicates whether all the resource for the instance is ok.
                  Values are as below:
                    Initializing - Resource is in Initializing or Reconcile
                    Ready        - All resources is ok. In most cases, Ready means the cluster is ok to use
                    Error        - Error found when do resource init
                type: string
              proxyMatchLabels:
                additionalProperties:
                  type: string
                description: Matching label selector for Valkey proxy.
                type: object
              proxyServiceName:
                description: The name of the kubernetes Service for Valkey Proxy
                type: string
              serviceName:
                description: The name of the kubernetes Service for Valkey
                type: string
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
