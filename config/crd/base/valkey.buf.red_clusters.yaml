---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.15.0
  name: clusters.valkey.buf.red
spec:
  group: valkey.buf.red
  names:
    kind: Cluster
    listKind: ClusterList
    plural: clusters
    singular: cluster
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - description: Current Shards
      jsonPath: .status.numberOfMaster
      name: Shards
      type: integer
    - description: Service status
      jsonPath: .status.serviceStatus
      name: Service Status
      type: string
    - description: Instance access type
      jsonPath: .spec.expose.type
      name: Access
      type: string
    - description: Instance phase
      jsonPath: .status.phase
      name: Phase
      type: string
    - description: Status message
      jsonPath: .status.reason
      name: Message
      type: string
    - description: Time since creation
      jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: Cluster is the Schema for the clusters API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: ClusterSpec defines the desired state of Cluster
            properties:
              CustomAffinity:
                $ref: '#/definitions/k8s.io~1api~1core~1v1~0Affinity'
                description: Affinity
              affinityPolicy:
                description: AffinityPolicy
                enum:
                - SoftAntiAffinity
                - AntiAffinityInSharding
                - AntiAffinity
                type: string
              annotations:
                additionalProperties:
                  type: string
                description: PodAnnotations
                type: object
              customConfigs:
                additionalProperties:
                  type: string
                description: |-
                  CustomConfigs is the custom redis configuration


                  Most of the settings is key-value format.
                type: object
              exporter:
                description: Exporter
                properties:
                  enabled:
                    description: Enabled enable the exporter
                    type: boolean
                  image:
                    description: Image the exporter image
                    type: string
                  imagePullPolicy:
                    $ref: '#/definitions/k8s.io~1api~1core~1v1~0PullPolicy'
                    description: ImagePullPolicy
                  resources:
                    $ref: '#/definitions/k8s.io~1api~1core~1v1~0ResourceRequirements'
                    description: Resources for setting resource requirements for the
                      Pod Resources *v1.ResourceRequirements
                type: object
              expose:
                description: Access defines the access for redis
                properties:
                  annotations:
                    additionalProperties:
                      type: string
                    description: The annnotations of the service which will be attached
                      to services
                    type: object
                  certIssuer:
                    description: Cert Issuer for external access TLS certificate
                    type: string
                  certIssuerType:
                    default: ClusterIssuer
                    description: Cert Issuer Type for external access TLS certificate
                    enum:
                    - ClusterIssuer
                    - Issuer
                    type: string
                  defaultPasswordSecret:
                    description: |-
                      DefaultPasswordSecret referered to the secret which defined the password for default user
                      The referered secret must have `password` key whose value matching regex: ^[a-zA-Z0-9_!@#$%^&*()-_=+?]{8,128}$
                    type: string
                  enableTLS:
                    description: EnableTLS enable TLS for external access
                    type: boolean
                  ipFamilyPrefer:
                    $ref: '#/definitions/k8s.io~1api~1core~1v1~0IPFamily'
                    description: |-
                      IPFamily represents the IP Family (IPv4 or IPv6).
                      This type is used to express the family of an IP expressed by a type (e.g. service.spec.ipFamilies).
                    enum:
                    - IPv4
                    - IPv6
                  ports:
                    description: Ports defines the nodeports of NodePort service
                    pattern: ^([0-9]+:[0-9]+)(,[0-9]+:[0-9]+)*$
                    type: string
                  type:
                    $ref: '#/definitions/k8s.io~1api~1core~1v1~0ServiceType'
                    default: ClusterIP
                    description: ServiceType defines the type of the all related services
                    enum:
                    - NodePort
                    - LoadBalancer
                    - ClusterIP
                type: object
              image:
                description: Image is the Redis image
                type: string
              imagePullPolicy:
                $ref: '#/definitions/k8s.io~1api~1core~1v1~0PullPolicy'
                description: ImagePullPolicy is the Redis image pull policy
              imagePullSecrets:
                description: ImagePullSecrets
                items:
                  $ref: '#/definitions/k8s.io~1api~1core~1v1~0LocalObjectReference'
                type: array
              nodeSelector:
                additionalProperties:
                  type: string
                description: NodeSelector
                type: object
              replicas:
                description: Replicas is the number of cluster replicas
                properties:
                  masterSize:
                    default: 3
                    description: Shards is the number of cluster shards
                    format: int32
                    maximum: 100
                    minimum: 3
                    type: integer
                  replicasOfShard:
                    description: ReplicasOfShard is the number of replicas for each
                      master node
                    format: int32
                    maximum: 5
                    minimum: 0
                    type: integer
                  shardsConfig:
                    description: ShardsConfig is the configuration of each shard
                    items:
                      properties:
                        slots:
                          description: 'Slots is the slot range for the shard, eg:
                            0-1000,1002,1005-1100'
                          pattern: ^(\d{1,5}|(\d{1,5}-\d{1,5}))(,(\d{1,5}|(\d{1,5}-\d{1,5})))*$
                          type: string
                      type: object
                    minItems: 3
                    type: array
                required:
                - masterSize
                - replicasOfShard
                type: object
              resources:
                $ref: '#/definitions/k8s.io~1api~1core~1v1~0ResourceRequirements'
                description: Resources
              securityContext:
                $ref: '#/definitions/k8s.io~1api~1core~1v1~0PodSecurityContext'
                description: SecurityContext
              storage:
                description: Storage
                properties:
                  accessMode:
                    $ref: '#/definitions/k8s.io~1api~1core~1v1~0PersistentVolumeAccessMode'
                    default: ReadWriteOnce
                    description: AccessMode is the access mode of the volume.
                  capacity:
                    anyOf:
                    - type: integer
                    - type: string
                    description: |-
                      Capacity is the cap of the volume to request.
                      if not set and StorageClassName is set, the default StorageClass size will be the double size of memory limit.
                    pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                    x-kubernetes-int-or-string: true
                  retainAfterDeleted:
                    description: RetainAfterDeleted defines whether the storage should
                      be retained after the ValkeyCluster is deleted
                    type: boolean
                  storageClassName:
                    description: |-
                      storageClassName is the name of the StorageClass required by the claim.
                      if not set, the default StorageClass will be used
                    type: string
                type: object
              tolerations:
                description: Tolerations
                items:
                  $ref: '#/definitions/k8s.io~1api~1core~1v1~0Toleration'
                type: array
            required:
            - replicas
            type: object
          status:
            description: ClusterStatus defines the observed state of Cluster
            properties:
              clusterStatus:
                description: ServiceStatus the cluster service status
                type: string
              message:
                description: Message the message of the status
                type: string
              nodes:
                description: Nodes the redis cluster nodes
                items:
                  description: ValkeyNode represent a ValkeyCluster Node
                  properties:
                    id:
                      description: ID is the valkey cluster node id, not runid
                      type: string
                    ip:
                      description: IP is the ip of the node. if access announce is
                        enabled, it will be the access ip
                      type: string
                    masterRef:
                      description: MasterRef is the master node id of this node
                      type: string
                    nodeName:
                      description: NodeName is the node name of the node where holds
                        the pod
                      type: string
                    podName:
                      description: PodName current pod name
                      type: string
                    port:
                      description: Port is the port of the node. if access announce
                        is enabled, it will be the access port
                      type: string
                    role:
                      description: Role is the role of the node, master or slave
                      type: string
                    shardId:
                      description: ShardID cluster shard id of the node
                      type: string
                    slots:
                      description: 'Slots is the slot range for the shard, eg: 0-1000,1002,1005-1100'
                      type: string
                    statefulSet:
                      description: StatefulSet is the statefulset name of this pod
                      type: string
                  required:
                  - ip
                  - nodeName
                  - podName
                  - port
                  - role
                  - statefulSet
                  type: object
                type: array
              shards:
                description: Shards the cluster shards
                items:
                  description: ClusterShards
                  properties:
                    id:
                      description: ID match the shard-id in redis 7.0
                      type: string
                    index:
                      description: Index the shard index
                      format: int32
                      type: integer
                    slots:
                      description: Slots records the slots status of this shard
                      items:
                        description: ClusterShardsSlotStatus
                        properties:
                          shardId:
                            description: ShardIndex indicates the slots importing
                              from or migrate to
                            format: int32
                            type: integer
                          slots:
                            description: Slots slots this shard holds or will holds
                            type: string
                          status:
                            description: Status the status of this status
                            type: string
                        required:
                        - shardId
                        type: object
                      type: array
                  required:
                  - index
                  - slots
                  type: object
                type: array
              status:
                description: Status the status of the cluster
                type: string
            required:
            - status
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
